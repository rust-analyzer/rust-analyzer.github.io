<!DOCTYPE html>
<html lang="en-US">

<head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Macros vs Rename</title>
  <meta name="description"
    content="I&#8217;ve already written before about how precise code completion is impossible to do inside Rust macros:https://github.com/matklad/proc-caesar. Today I&#8...">

  <link rel="stylesheet" href="/css/asciidoctor.css">
  <link rel="stylesheet" href="/css/rouge-github.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <!-- dark mode -->
  <script type="module" src="/js/nightowl.js"></script>

  <link rel="canonical" href="https://rust-analyzer.github.io//blog/2020/03/30/macros-vs-rename.html">
  <link rel="alternate" type="application/rss+xml" title="rust-analyzer"
    href="https://rust-analyzer.github.io//feed.xml">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/fav/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/fav/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/fav/favicon-16x16.png">
  <link rel="manifest" href="/assets/site.webmanifest">
  <link rel="mask-icon" href="/assets/fav/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  
  <header>
    <div id="header-inner">
      <div class="nightowl-daylight" id="header-left">
        <a class="site-title" href="/">
          <img src="/assets/rust-analyzer.svg" alt="rust analyzer" id="header-logo">
        </a>
      </div>
      <div id="header-right">
        <a class="nav-link" href="https://opencollective.com/rust-analyzer/">Sponsor</a>
        <a class="nav-link" href="/manual.html">Docs</a>
        <a class="nav-link" href="/blog">Blog</a>
        <a class="nav-link" href="/thisweek">Changelog</a>
      </div>
    </div>
  </header>
  

  <main>
    <article>
<h1>Macros vs Rename</h1>
<div class="post-meta sect1">
  @matklad, Mar 30, 2020
</div>
<div class="paragraph">
<p>I&#8217;ve already written before about how precise code completion is impossible to do inside Rust macros:
<a href="https://github.com/matklad/proc-caesar" class="bare">https://github.com/matklad/proc-caesar</a>. Today I&#8217;d like to write a short note about another impossibility result:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Correct automatic rename is not possible in a language with rust-style macros.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="nd">macro_rules!</span> <span class="n">call_foo</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">mod</span> <span class="n">a</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">call_foo!</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">mod</span> <span class="n">b</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">call_foo!</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>What is the expected result for renaming <code>a::foo</code> to <code>bar</code>?
There isn&#8217;t one, as the same macro refers to different <code>foo</code> at different call-sites!</p>
</div>
<div class="paragraph">
<p>But the problem is even deeper than ambiguity.
Consider this (silly) crate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">HELLO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">;</span>

<span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">say_hello</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="nv">$crate</span><span class="p">::</span><span class="n">HELLO</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, it is pretty clear what we want to get after renaming <code>HELLO</code> to <code>GREETING</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">GREETING</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">;</span>

<span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">say_hello</span> <span class="p">{</span>
    <span class="p">()</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="nv">$crate</span><span class="p">::</span><span class="n">GREETING</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, it is impossible to formalize this transformation.
To the human reader, it is <em>obvious</em> that the right hand side of a macro should be parsed as an expression.
But this intuition is flawed&#8201;&#8212;&#8201;the right hand side is just a sequence of tokens, and it receives a meaning only when we call the macro.
And there&#8217;s no guarantee, in general case, that it would be interpreted as an expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">const</span> <span class="n">HELLO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">;</span>

<span class="nd">macro_rules!</span> <span class="n">m</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$tt:tt</span><span class="p">)</span><span class="o">*</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nv">$</span><span class="p">(</span><span class="nv">$tt</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nv">$crate</span><span class="p">::</span><span class="n">HELLO</span><span class="p">)</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">expr</span> <span class="o">=</span> <span class="nd">m!</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">convert</span><span class="p">::</span><span class="n">identity</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">tt</span> <span class="o">=</span> <span class="nd">m!</span><span class="p">(</span><span class="nd">stringify!</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"expr = {},tt = {}"</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">tt</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Together this means that the theoretically best definition of <strong>correct automated rename</strong> we can get in Rust is limited.
We can handle code outside the macros and code inside macro calls.
For macro definitions, at best we can give a list of locations that require manual intervention.</p>
</div>
<div class="paragraph">
<p>It also seems plausible that, with some heuristic, we can infer renames in macro definitions as well.
For example, we can look at all call sites of the macro, and see if they all agree that a certain token in the macro definition needs change.</p>
</div>
</article>

  </main>

  <footer>
    <div id="footer-inner">
      <div class="footer-by">
        <a href="https://ferrous-systems.com/">
          <img class="ferrous-logo" src="/assets/ferrous-logo.png">Ferrous Systems</a>
        &
        <a href="https://github.com/rust-analyzer/rust-analyzer/graphs/contributors">contributors</a>
      </div>

      <div id="footer-links">
        <a href="/feed.xml" class="footer-link">
          <i class="fa fa-rss"></i> rss
        </a>
        <a href="https://github.com/rust-analyzer/rust-analyzer.github.io" class="footer-link">
          <i class="fa fa-github"></i> src
        </a>
        <a href="https://opencollective.com/rust-analyzer/" class="footer-link">
          <i class="fa fa-github"></i> sponsor
        </a>
      </div>
    </div>
  </footer>
</body>

</html>
